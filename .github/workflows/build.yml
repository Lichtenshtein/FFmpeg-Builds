name: Build FFmpeg

on:
  workflow_dispatch:
    inputs:
      doRelease:
        description: 'Publish new release'
        type: boolean
        default: false
        required: false

env:
  DOCKER_BUILDKIT: 1
  TARGET: win64
  VARIANT: nonfree

jobs:
  build_all:
    name: Build FFmpeg Win64
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Host Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y subversion subversion-tools nasm yasm

      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          # remove unused Docker images left over from the Base and Win64-Base builds
          docker image prune -af

      - name: Set Image Names
        id: images
        run: |
          REPO_LC="${GITHUB_REPOSITORY,,}"
          echo "repo_lc=ghcr.io/${REPO_LC}" >> $GITHUB_OUTPUT
          echo "base=ghcr.io/${REPO_LC}/base:latest" >> $GITHUB_OUTPUT
          echo "target_base=ghcr.io/${REPO_LC}/base-win64:latest" >> $GITHUB_OUTPUT
          echo "variant=ghcr.io/${REPO_LC}/win64-nonfree:latest" >> $GITHUB_OUTPUT

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build Base Image
        uses: docker/build-push-action@v5
        with:
          context: images/base
          push: true
          tags: ${{ steps.images.outputs.base }}
          cache-from: type=gha,scope=base
          cache-to: type=gha,mode=max,scope=base

      - name: Get Download Cache Key
        id: dl_cache
        run: |
          KEY=$(./util/get_dl_cache_tag.sh)
          echo "Cache Key: $KEY"
          echo "key=$KEY" >> $GITHUB_OUTPUT

      - name: Restore/Save Source Cache
        uses: actions/cache@v4
        with:
          path: |
            .cache/downloads
            .cache/ffmpeg
          key: dl-cache-${{ steps.dl_cache.outputs.key }}-${{ github.run_id }}
          restore-keys: |
            dl-cache-${{ steps.dl_cache.outputs.key }}-
            dl-cache-

      - name: Run Download and Generate
        run: |
          git config --global advice.detachedHead false
          # Создаем директории на случай, если кэш пустой
          mkdir -p .cache/downloads
          mkdir -p .cache/ffmpeg
          # Запускаем логику загрузки и генерации Dockerfile
          ./download.sh
          ./generate.sh win64 nonfree
        env:
          TARGET: win64
          VARIANT: nonfree

      - name: Inspect Dockerfile
        run: head -n 5 Dockerfile

            # ghcr.io/${{ steps.images.outputs.repo_lc }}/base-win64:latest=docker-image://${{ steps.images.outputs.target_base }}

      - name: Prepare and Build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: false
          tags: ${{ steps.images.outputs.variant }}
          cache-from: type=gha,scope=ffmpeg-build
          cache-to: type=gha,mode=max,scope=ffmpeg-build
          build-contexts: |
            ${{ steps.images.outputs.target_base }}=docker-image://${{ steps.images.outputs.target_base }}
            downloads=.cache/downloads
            ffmpeg_src=.cache/ffmpeg
          outputs: type=local,dest=artifacts/

      - name: Force Save Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .cache/downloads
          key: dl-cache-${{ steps.dl_cache.outputs.key }}-${{ github.run_id }}

      - name: Cleanup Old Caches
        if: always()
        run: |
          gh extension install actions/gh-actions-cache || true
          echo "Fetching list of caches..."
          caches=$(gh actions-cache list --limit 100 --order desc | cut -f 1)
          
          # Оставляем только 5 последних кэшей, остальные удаляем
          count=0
          for cache in $caches; do
            ((count++))
              if [ $count -gt 5 ]; then
                echo "Deleting old cache: $cache"
                gh actions-cache delete "$cache" --confirm
              fi
          done
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Upload Final Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-win64-nonfree
          path: artifacts/*.7z
          if-no-files-found: error

      - name: Create Release
        if: ${{ github.event.inputs.doRelease == 'true' && success() }}
        run: |
          RELDATE="$(date +'%Y-%m-%d %H:%M')"
          TAGNAME="autobuild-$(date +'%Y-%m-%d-%H-%M')"
          (cd artifacts && sha256sum *.7z > checksums.sha256)
          gh release create "$TAGNAME" --target "${{ github.ref_name }}" \
            --title "Auto-Build $RELDATE" artifacts/*.7z artifacts/checksums.sha256
        env:
          GITHUB_TOKEN: ${{ github.token }}
