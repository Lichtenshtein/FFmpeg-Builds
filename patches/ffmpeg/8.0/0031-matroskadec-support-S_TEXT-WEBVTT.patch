From b0b393ca12a0794b66e29e1d5b31ff29480862ce Mon Sep 17 00:00:00 2001
From: wang-bin <wbsecg1@gmail.com>
Date: Tue, 17 Dec 2024 23:21:57 +0800
Subject: [PATCH 31/33] matroskadec: support S_TEXT/WEBVTT

fix ticket #5641
---
 libavformat/matroska.c    |  1 +
 libavformat/matroskadec.c | 29 +++++++++++++++++++++++++++++
 2 files changed, 30 insertions(+)

diff --git a/libavformat/matroska.c b/libavformat/matroska.c
index 60584e2687..4b28df5057 100644
--- a/libavformat/matroska.c
+++ b/libavformat/matroska.c
@@ -63,6 +63,7 @@ const CodecTags ff_mkv_codec_tags[]={
     {"D_WEBVTT/CAPTIONS"    , AV_CODEC_ID_WEBVTT},
     {"D_WEBVTT/DESCRIPTIONS", AV_CODEC_ID_WEBVTT},
     {"D_WEBVTT/METADATA"    , AV_CODEC_ID_WEBVTT},
+    {"S_TEXT/WEBVTT"        , AV_CODEC_ID_WEBVTT},
 
     {"S_TEXT/UTF8"      , AV_CODEC_ID_SUBRIP},
     {"S_TEXT/UTF8"      , AV_CODEC_ID_TEXT},
diff --git a/libavformat/matroskadec.c b/libavformat/matroskadec.c
index 1e0c75c51b..4d01821c5c 100644
--- a/libavformat/matroskadec.c
+++ b/libavformat/matroskadec.c
@@ -3771,6 +3771,7 @@ static int matroska_parse_webvtt(MatroskaDemuxContext *matroska,
                                  MatroskaTrack *track,
                                  AVStream *st,
                                  uint8_t *data, int data_len,
+                                 MatroskaBlockMore *blockmore, int nb_blockmore,
                                  uint64_t timecode,
                                  uint64_t duration,
                                  int64_t pos)
@@ -3780,13 +3781,28 @@ static int matroska_parse_webvtt(MatroskaDemuxContext *matroska,
     int id_len, settings_len, text_len;
     uint8_t *p, *q;
     int err;
+    const int webm_style = !strncmp(track->codec_id, "D_WEBVTT/", 9);
 
     if (data_len <= 0)
         return AVERROR_INVALIDDATA;
 
+    if (!webm_style) {
+        text = data;
+        text_len = data_len;
+        if (nb_blockmore <= 0)
+            goto make_pkt;
+        data = blockmore->additional.data;
+        data_len = blockmore->additional.size;
+    }
+
     p = data;
     q = data + data_len;
 
+    if (webm_style)
+        goto parse_id;
+    goto parse_settings;
+
+parse_id:
     id = p;
     id_len = -1;
     while (p < q) {
@@ -3802,7 +3818,11 @@ static int matroska_parse_webvtt(MatroskaDemuxContext *matroska,
     if (p >= q || *p != '\n')
         return AVERROR_INVALIDDATA;
     p++;
+    if (webm_style)
+        goto parse_settings;
+    goto make_pkt;
 
+parse_settings:
     settings = p;
     settings_len = -1;
     while (p < q) {
@@ -3818,7 +3838,11 @@ static int matroska_parse_webvtt(MatroskaDemuxContext *matroska,
     if (p >= q || *p != '\n')
         return AVERROR_INVALIDDATA;
     p++;
+    if (webm_style)
+        goto parse_text;
+    goto parse_id;
 
+parse_text:
     text = p;
     text_len = q - p;
     while (text_len > 0) {
@@ -3829,6 +3853,10 @@ static int matroska_parse_webvtt(MatroskaDemuxContext *matroska,
         text_len = len;
     }
 
+make_pkt:
+    if (text_len <= 0)
+        return AVERROR_INVALIDDATA;
+
     err = av_new_packet(pkt, text_len);
     if (err < 0) {
         return err;
@@ -4218,6 +4246,7 @@ static int matroska_parse_block(MatroskaDemuxContext *matroska, AVBufferRef *buf
         } else if (st->codecpar->codec_id == AV_CODEC_ID_WEBVTT) {
             res = matroska_parse_webvtt(matroska, track, st,
                                         out_data, out_size,
+                                        blockmore, nb_blockmore,
                                         timecode, lace_duration,
                                         pos);
             if (!buf)
-- 
2.49.0

